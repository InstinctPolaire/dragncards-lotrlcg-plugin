{
    "automation": {
        "postLoadActionList": [
            ["DEFINE", "$LOADED_PLAYER_DECK", false],
            ["DEFINE", "$THREAT_RAISE", 0],
            ["FOR_EACH_VAL", "$CARD_ID", "$GAME.loadedCardIds", [
                ["DEFINE", "$CARD", "$GAME.cardById.$CARD_ID"],
                ["COND", 
                    ["EQUAL", "$CARD.sides.A.type", "Hero"],
                    [
                        ["DEFINE", "$LOADED_PLAYER_DECK", true],
                        ["DEFINE", "$CONTROLLER", "$CARD.controller"],
                        ["DEFINE", "$THREAT_RAISE", ["ADD", "$THREAT_RAISE", "$CARD.sides.A.cost"]],
                        ["SET", "/playerData/$CONTROLLER/threat", 0]
                    ]
                ],
                ["COND",
                    ["IN_STRING", "$CARD.groupId", "Play1"],
                    [
                        ["SET", "/cardById/$CARD_ID/deckGroupId", ["JOIN_STRING", "$PLAYER_N", "Deck"]],
                        ["SET", "/cardById/$CARD_ID/discardGroupId", ["JOIN_STRING", "$PLAYER_N", "Discard"]]
                    ],
                    ["IN_LIST", ["LIST", "sharedStagingArea", "sharedActiveLocation"], "$CARD.groupId"],
                    [
                        ["SET", "/cardById/$CARD_ID/deckGroupId", "sharedEncounterDeck"],
                        ["SET", "/cardById/$CARD_ID/discardGroupId", "sharedEncounterDiscard"]
                    ]
                ],
                ["COND", 
                    ["AND", ["EQUAL", "$CARD.sides.A.type", "Quest"], ["EQUAL", "$CARD.sides.A.cost", 1]],
                    [
                        ["LOG", "├── ", "Made ", "$CARD.sides.A.name", " the main quest."],
                        ["MOVE_CARD", "$CARD_ID", "sharedMainQuest", 0]
                    ]
                ]
            ]],
            ["DEFINE", "$PLAYER_N_HAND_GROUP_ID", ["JOIN_STRING", "$PLAYER_N", "Hand"]],
            ["COND",
                "$LOADED_PLAYER_DECK",
                [
                    ["LOG", "├── ", "$PLAYER_N", " set their starting threat to ", "$THREAT_RAISE", "."],
                    ["SET", "/playerData/$PLAYER_N/threat", "$THREAT_RAISE"]
                ]
            ],
            ["COND",
                ["AND", "$LOADED_PLAYER_DECK", ["EQUAL", "$GAME.roundNumber", 0], ["EQUAL", ["LENGTH", "$GAME.groupById.$PLAYER_N_HAND_GROUP_ID.stackIds"], 0]],
                [
                    ["LOG", "└── ", "$PLAYER_N", " draws 6 cards."],
                    ["DRAW_CARD", 6]
                ]
            ]
        ],
        "gameRules": [
            { 
                "_comment": "Remove committed willpower from a character leaving play",
                "type": "trigger", 
                "listenTo": ["/cardById/*/inPlay"],
                "condition": ["AND", ["NOT", "$TARGET.inPlay"], ["PREV", "$TARGET.inPlay"], ["PREV", "$TARGET.committed"]],
                "then": [
                    ["DEFINE", "$QUESTING_STAT", "$GAME.questingStat"],
                    ["DEFINE", "$COMMITTED_VAL", ["PREV", ["ADD", "$TARGET.currentFace.$QUESTING_STAT", "$TARGET.tokens.$QUESTING_STAT"]]],
                    ["DECREASE_VAL", "/playerData/$TARGET.controller/willpower", "$COMMITTED_VAL"],
                    ["LOG", "└── ", "$TARGET.controller", " lost ", "$COMMITTED_VAL", " ", "$QUESTING_STAT", " toward the quest."]
                ]
            },
            { 
                "_comment": "Adjust committed value when token is adjusted",
                "type": "trigger", 
                "listenTo": ["/cardById/*/tokens/willpower"],
                "condition": ["AND", "$TARGET.committed", ["EQUAL", "$GAME.questingStat", "willpower"]],
                "then": [
                    ["DEFINE", "$DELTA", ["SUBTRACT", "$TARGET.tokens.willpower", ["PREV", "$TARGET.tokens.willpower"]]],
                    ["DEFINE", "$QUESTING_STAT", "$GAME.questingStat"],
                    ["INCREASE_VAL", "/playerData/$TARGET.controller/willpower", "$DELTA"]
                ]
            },
            { 
                "_comment": "Adjust committed value when token is adjusted",
                "type": "trigger", 
                "listenTo": ["/cardById/*/tokens/attack"],
                "condition": ["AND", "$TARGET.committed", ["EQUAL", "$GAME.questingStat", "attack"]],
                "then": [
                    ["DEFINE", "$DELTA", ["SUBTRACT", "$TARGET.tokens.attack", ["PREV", "$TARGET.tokens.attack"]]],
                    ["DEFINE", "$QUESTING_STAT", "$GAME.questingStat"],
                    ["INCREASE_VAL", "/playerData/$TARGET.controller/willpower", "$DELTA"]
                ]
            },
            { 
                "_comment": "Adjust committed value when token is adjusted",
                "type": "trigger", 
                "listenTo": ["/cardById/*/tokens/defense"],
                "condition": ["AND", "$TARGET.committed", ["EQUAL", "$GAME.questingStat", "defense"]],
                "then": [
                    ["DEFINE", "$DELTA", ["SUBTRACT", "$TARGET.tokens.defense", ["PREV", "$TARGET.tokens.defense"]]],
                    ["DEFINE", "$QUESTING_STAT", "$GAME.questingStat"],
                    ["INCREASE_VAL", "/playerData/$TARGET.controller/willpower", "$DELTA"]
                ]
            },
            { 
                "_comment": "Adjust staging threat when a card is added/removed",
                "type": "trigger", 
                "listenTo": ["/cardById/*/groupId", "/cardById/*/currentSide"],
                "condition": ["AND", ["NOT_EQUAL", "$TARGET.currentSide", null], ["GREATER_THAN", "$TARGET.currentFace.threat", 0],
                                ["OR", ["EQUAL", "$TARGET.groupId", "sharedStagingArea"], ["PREV", ["EQUAL", "$TARGET.groupId", "sharedStagingArea"]]]],
                "then": [
                    ["DEFINE", "$STAGING_THREAT", 0],
                    ["FOR_EACH_VAL", "$CARD_ID", "$GAME.groupById.sharedStagingArea.parentCardIds", [
                        ["DEFINE", "$CARD", "$GAME.cardById.$CARD_ID"],
                        ["DEFINE", "$STAGING_THREAT", ["ADD", "$STAGING_THREAT", "$CARD.currentFace.threat"]]
                    ]],
                    ["LOG", "└── ", "Staging threat is now ", "$STAGING_THREAT", "."],
                    ["SET", "/stagingThreat", "$STAGING_THREAT"]
                ]
            },
            { 
                "_comment": "Adjust staging threat when a threat token is added/removed",
                "type": "trigger", 
                "listenTo": ["/cardById/*/tokens/threat"],
                "condition": ["AND", ["EQUAL", "$TARGET.groupId", "sharedStagingArea"]],
                "then": [
                    ["LOG_DEV", "$GAME.stagingThreat"],
                    ["DEFINE", "$DELTA", ["SUBTRACT", "$TARGET.tokens.threat", ["PREV", "$TARGET.tokens.threat"]]],
                    ["LOG_DEV", "$DELTA"],
                    ["INCREASE_VAL", "/stagingThreat", "$DELTA"],
                    ["LOG_DEV", "$GAME.stagingThreat"]
                ]
            },
            { 
                "_comment": "Adjust expected progress",
                "type": "trigger", 
                "listenTo": ["/stagingThreat", "/playerData/*/willpower"],
                "condition": ["TRUE"],
                "then": [
                    ["DEFINE", "$TOTAL_QUESTING", 0],
                    ["FOR_EACH_VAL", "$PLAYER_I", "$PLAYER_ORDER", [
                        ["DEFINE", "$TOTAL_QUESTING", ["ADD", "$TOTAL_QUESTING", "$GAME.playerData.$PLAYER_I.willpower"]]
                    ]],
                    ["DEFINE", "$EXPECTED_PROGRESS", ["SUBTRACT", "$TOTAL_QUESTING", "$GAME.stagingThreat"]],
                    ["LOG", "└── ", "Expected progress is now ", "$EXPECTED_PROGRESS", "."],
                    ["SET", "/questProgress", "$EXPECTED_PROGRESS"]
                ]
            },
            { 
                "_comment": "Turn cards red when they have 0 hit points left",
                "type": "passive", 
                "listenTo": ["/cardById/*/tokens/damage", "/cardById/*/tokens/hitPoints"],
                "condition": ["GREATER_EQUAL", "$TARGET.tokens.damage", ["ADD", "$TARGET.currentFace.hitPoints", "$TARGET.tokens.hitPoints"]],
                "onDo": [
                    ["LOG", "└── ", "$TARGET.currentFace.name", " is destroyed."],
                    ["SET", "/cardById/$TARGET_ID/borderColor", "red"]
                ],
                "offDo": [
                    ["SET", "/cardById/$TARGET_ID/borderColor", null]
                ]
            },
            { 
                "_comment": "Turn cards green when they have 0 quest points left",
                "type": "passive", 
                "listenTo": ["/cardById/*/tokens/progress", "/cardById/*/tokens/hitPoints"],
                "condition": ["GREATER_EQUAL", "$TARGET.tokens.progress", ["ADD", "$TARGET.currentFace.questPoints", "$TARGET.tokens.hitPoints"]],
                "onDo": [
                    ["LOG", "└── ", "$TARGET.currentFace.name", " is explored."],
                    ["SET", "/cardById/$TARGET_ID/borderColor", "green"]
                ],
                "offDo": [
                    ["SET", "/cardById/$TARGET_ID/borderColor", null]
                ]
            }
        ],
        "cards": {
        }
    }
}